<!doctype html>
<!--
	Copyright (c) 2000-2016 Liferay, Inc. All rights reserved.

	This library is free software; you can redistribute it and/or modify it under
	the terms of the GNU Lesser General Public License as published by the Free
	Software Foundation; either version 2.1 of the License, or (at your option)
	any later version.

	This library is distributed in the hope that it will be useful, but WITHOUT
	ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
	FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
	details.
-->
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8"/>
		<title>Markdown to Liferay Forums (BBCode) Converter</title>
		<style>
			.textarea {
				font-family: "Courier New", Courier, monospace;
				font-size: 15px;
			}
		</style>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
		<script type="text/javascript">

			function unescape(text) {
				// split and join are used instead of replace since replace does not replace all occurences. For more
				// details see: http://stackoverflow.com/questions/1144783/how-to-replace-all-occurrences-of-a-string-in-javascript#1145525
				return text.split('&lt;').join('<')
						.split('&gt;').join('>')
						.split('&quot;').join('"')
						.split('&#39;').join("'")
						.split('&amp;').join('&');
			}

			var liferayForumsBBCodeRenderer = new marked.Renderer();

			liferayForumsBBCodeRenderer.code = function (text, language /* unused */) {

				if (document.getElementById('useCodeTags').checked) {
					return '\n[code]' + text + '[/code]';
				} else {
					return '\n[size=4][font=Courier New]' + text + '[/font][/size]\n';
				}
			};

			liferayForumsBBCodeRenderer.blockquote = function (text) {
				return '\n[quote]' + unescape(text) + '[/quote]';
			};

			liferayForumsBBCodeRenderer.heading = function (text, level) {

				if (level === 1) {
					size = 7;
				} else if (level === 2) {
					size = 6;
				} else if (level >= 3) {
					size = 5;
				}

				return '[size=' + size + '][b]' + unescape(text) + '[/b][/size]\n';
			};

			liferayForumsBBCodeRenderer.hr = function () {
				return '[center][b]--------------------------------------------------------------------------------------------[/b][/center]';
			};

			liferayForumsBBCodeRenderer.list = function (body, ordered) {

				var beginTag = '\n[list';

				if (ordered) {
					beginTag += '=1';
				}

				beginTag += ']\n';

				return beginTag + unescape(body) + '[/list]\n';
			};

			liferayForumsBBCodeRenderer.listitem = function (text) {
				return '[*]' + unescape(text.replace(/^\n/, '')) + '\n';
			};

			liferayForumsBBCodeRenderer.paragraph = function (text) {
				return '\n' + unescape(text) + '\n';
			};

			liferayForumsBBCodeRenderer.strong = function (text) {
				return '[b]' + unescape(text) + '[/b]';
			};

			liferayForumsBBCodeRenderer.em = function (text) {
				return '[i]' + unescape(text) + '[/i]';
			};

			liferayForumsBBCodeRenderer.codespan = function (text) {
				return '[font=Courier New]' + unescape(text) + '[/font]';
			};

			liferayForumsBBCodeRenderer.br = function () {
				return '\n';
			};

			liferayForumsBBCodeRenderer.del = function (text) {
				return '[s]' + unescape(text) + '[/s]';
			};

			liferayForumsBBCodeRenderer.link = function (href, title, text) {

				var endTag = '[/url]';

				if (title && title !== '') {
					endTag += ' (' + title + ')';
				}

				return '[url=' + href + ']' + unescape(text) + endTag;
			};

			liferayForumsBBCodeRenderer.image = function (href, title, text) {

				var beginTag = '';

				if (title && title !== '') {
					beginTag += '[size=5][b]' + unescape(title) + '[/b][/size]\n';
				}

				if (text && text !== '') {
					beginTag += unescape(text) + '\n';
				}

				beginTag += '[image]';

				return beginTag + href + '[/image]';
			};

			marked.setOptions({
				renderer: liferayForumsBBCodeRenderer,
				gfm: true,
				tables: true,
				breaks: true,
				pedantic: false,
				sanitize: false,
				smartLists: true,
				smartypants: false
			});

			function convert() {

				var markdown = document.getElementById("markdown_text");
				var bbcode = document.getElementById("bbcode_text");

				var markdown_value = markdown.value;
				//general Markdown conversion
				markdown_value = marked(markdown_value);

				if (markdown_value.charAt(0) === '\n') {
					markdown_value = markdown_value.substr(1);
				}

				bbcode.value = markdown_value;
				console.log('converted');
			}

			function indentOrUnindent(indent) {

				var markdown = document.getElementById("markdown_text");
				var selectionStart = markdown.selectionStart;
				var selectionEnd = markdown.selectionEnd;
				var firstLineIndex = markdown.value.substring(0, selectionStart).lastIndexOf('\n') + 1;

				if (firstLineIndex === -1) {
					firstLineIndex = 0;
				}

				var stringBeforeSelection = markdown.value.substring(0, firstLineIndex);
				var stringAfterSelection = markdown.value.substring(selectionEnd);
				var changedLines;
				var newSelectionIndex;

				if (indent) {
					newSelectionIndex = selectionStart + 4;
					changedLines = '    ' + markdown.value.substring(firstLineIndex, selectionEnd)
							.replace(/\n/g, '\n    ');
				} else {
					var textToUnindent = markdown.value.substring(firstLineIndex, markdown.selectionEnd);
					newSelectionIndex = selectionStart + (textToUnindent.startsWith('    ') ? -4 : 0);
					changedLines = textToUnindent.replace(/^    /, '')
							.replace(/\n    /g, '\n');
				}

				markdown.value = stringBeforeSelection + changedLines + stringAfterSelection;
				convert();
				markdown.focus();
				markdown.selectionStart = newSelectionIndex;
				markdown.selectionEnd = markdown.value.lastIndexOf(stringAfterSelection);
			}

			function indentSelectedLines() {
				indentOrUnindent(true);
			}

			function unindentSelectedLines() {
				indentOrUnindent(false);
			}
		</script>
	</head>
	<body>
		<div class="row">
			<h2>Markdown to Liferay Forums (BBCode) Converter</h2>
		</div>

		<div class="row">
			<p>
				Paste your Markdown formatted text into the top box and Liferay Forums BBCode appears in the bottom.
			</p>
			<button onclick="indentSelectedLines()">Indent Selected Lines</button>
			<button onclick="unindentSelectedLines()">Unindent Selected Lines</button>
			<label>
				<input id="useCodeTags" type="checkbox" onchange="convert();" />
				Use <code>[code]</code> tags (if unchecked, <code>[size=4][font=Courier New]</code> tags will be used
				instead since they do not render line numbers in the Liferay Forums so they are easier to copy/paste).
			</label>
			<textarea id="markdown_text" class="textarea" cols="120" rows="15" onChange="convert()" onKeyUp="convert()"
					  placeholder="Enter your Markdown formatted text here" onfocus="this.placeholder = ''"
					  onblur="this.placeholder = 'Enter your Markdown formatted text here'"></textarea>
			<textarea id="bbcode_text" class="textarea" cols="120" rows="15"
					  placeholder="Your BBCode formatted text will be automatically shown in this box"
					  onfocus="this.placeholder = ''"
					  onblur="this.placeholder = 'Your BBCode formatted text will be automatically shown in this box'"></textarea>
		</div>
		<script type="text/javascript">
			var bbcode = document.getElementById("bbcode_text");
			bbcode.onfocus = function () {

				bbcode.select();

				bbcode.onmouseup = function () {
					bbcode.onmouseup = null;
					return false;
				};
			};
		</script>
	</body>
</html>
